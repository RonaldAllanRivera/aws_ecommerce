services:
  mysql:
    image: mysql:8.0
    container_name: aws_ecommerce_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d

  redis:
    image: redis:7
    container_name: aws_ecommerce_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  mailhog:
    image: mailhog/mailhog:latest
    container_name: aws_ecommerce_mailhog
    restart: unless-stopped
    ports:
      - "8025:8025"

  catalog-app:
    build:
      context: ./services/catalog
      dockerfile: Dockerfile
    container_name: catalog_app
    restart: unless-stopped
    environment:
      APP_ENV: local
      APP_DEBUG: "true"
      APP_URL: http://localhost:8080/catalog
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: catalog_db
      DB_USERNAME: catalog_user
      DB_PASSWORD: catalog_password
      QUEUE_CONNECTION: redis
      SESSION_DRIVER: database
      CACHE_STORE: database
    volumes:
      - ./services/catalog:/var/www/html
    depends_on:
      - mysql
      - redis

  checkout-app:
    build:
      context: ./services/checkout
      dockerfile: Dockerfile
    container_name: checkout_app
    restart: unless-stopped
    environment:
      APP_ENV: local
      APP_DEBUG: "true"
      APP_URL: http://localhost:8080/checkout
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: checkout_db
      DB_USERNAME: checkout_user
      DB_PASSWORD: checkout_password
      QUEUE_CONNECTION: redis
      SESSION_DRIVER: database
      CACHE_STORE: database
    volumes:
      - ./services/checkout:/var/www/html
    depends_on:
      - mysql
      - redis

  email-app:
    build:
      context: ./services/email
      dockerfile: Dockerfile
    container_name: email_app
    restart: unless-stopped
    environment:
      APP_ENV: local
      APP_DEBUG: "true"
      APP_URL: http://localhost:8080/email
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: email_db
      DB_USERNAME: email_user
      DB_PASSWORD: email_password
      QUEUE_CONNECTION: redis
      SESSION_DRIVER: database
      CACHE_STORE: database
    volumes:
      - ./services/email:/var/www/html
    depends_on:
      - mysql
      - redis

  nginx:
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
    container_name: aws_ecommerce_nginx
    restart: unless-stopped
    ports:
      - "8080:80"
    depends_on:
      - catalog-app
      - checkout-app
      - email-app
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./services/catalog:/var/www/catalog
      - ./services/checkout:/var/www/checkout
      - ./services/email:/var/www/email
      - ./frontend/dist:/var/www/frontend:ro

volumes:
  mysql_data:
  redis_data:
